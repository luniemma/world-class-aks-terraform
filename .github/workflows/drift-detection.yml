name: Drift Detection

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check for drift'
        required: false
        type: choice
        options:
          - all
          - dev
          - staging
          - prod
        default: 'all'

permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: write

env:
  TERRAFORM_VERSION: '1.6.0'

jobs:
  drift-detection-dev:
    name: Drift Detection - Dev
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' || 
      inputs.environment == 'all' || 
      inputs.environment == 'dev'
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    outputs:
      drift_detected: ${{ steps.drift.outputs.drift_detected }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan (Drift Check)
        id: plan
        run: |
          set -o pipefail
          
          echo "Running drift detection plan for Dev environment..."
          echo "This is a READ-ONLY operation - no changes will be applied."
          echo ""
          
          terraform plan \
            -var-file=environments/dev.tfvars \
            -detailed-exitcode \
            -no-color \
            -lock=false \
            2>&1 | tee drift-dev.txt
          
          EXITCODE=${PIPESTATUS[0]}
          echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "Plan exit code: $EXITCODE"
          echo "  0 = No changes (no drift)"
          echo "  1 = Error"
          echo "  2 = Changes detected (drift found)"
          
          # Don't fail the step - we handle exit codes in the next step
          exit 0

      - name: Check for Drift
        id: drift
        run: |
          EXITCODE="${{ steps.plan.outputs.exitcode }}"
          
          if [ "$EXITCODE" == "2" ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "drift_status=detected" >> $GITHUB_OUTPUT
            echo ""
            echo "âš ï¸ DRIFT DETECTED in Dev environment"
            echo ""
            echo "### âš ï¸ Drift Detected in Dev Environment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Configuration drift was found. Review the plan output below." >> $GITHUB_STEP_SUMMARY
          elif [ "$EXITCODE" == "1" ]; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "drift_status=error" >> $GITHUB_OUTPUT
            echo ""
            echo "âŒ Terraform plan failed"
            echo ""
            echo "### âŒ Terraform Plan Failed in Dev Environment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The plan command failed. Check the logs for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "drift_status=clean" >> $GITHUB_OUTPUT
            echo ""
            echo "âœ… No drift detected in Dev environment"
            echo ""
            echo "### âœ… No Drift Detected in Dev Environment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure matches Terraform configuration." >> $GITHUB_STEP_SUMMARY
          fi
          
          # Add plan output to summary
          if [ -f drift-dev.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Plan Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 drift-dev.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Drift Report
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-dev-${{ github.run_number }}
          path: drift-dev.txt
          retention-days: 30

      - name: Create Issue for Drift
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const drift = fs.readFileSync('drift-dev.txt', 'utf8');
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['drift-detection', 'dev'],
              state: 'open'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'âš ï¸ Configuration Drift Detected - Dev Environment',
                body: `## Configuration Drift Detected
            
            Drift was detected in the **Dev** environment during scheduled checks.
            
            **Detection Time:** ${new Date().toISOString()}
            **Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ### Drift Details
            
            \`\`\`terraform
            ${drift.substring(0, 5000)}
            \`\`\`
            
            ### Recommended Actions
            1. Review the drift details above
            2. Determine if the changes are intentional
            3. Update Terraform code or revert manual changes
            4. Run \`terraform apply\` to align infrastructure with code
            
            ### Related Artifacts
            Download the full drift report from the Actions run artifacts.
            `,
                labels: ['drift-detection', 'dev', 'infrastructure']
              });
            } else {
              // Update existing issue with new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## Drift Still Present
            
            **Detection Time:** ${new Date().toISOString()}
            **Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            Drift is still present in the Dev environment. Please investigate.
            `
              });
            }

  drift-detection-staging:
    name: Drift Detection - Staging
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' || 
      inputs.environment == 'all' || 
      inputs.environment == 'staging'
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    outputs:
      drift_detected: ${{ steps.drift.outputs.drift_detected }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan (Drift Check)
        id: plan
        run: |
          set -o pipefail
          
          echo "Running drift detection plan for Staging environment..."
          echo "This is a READ-ONLY operation - no changes will be applied."
          echo ""
          
          terraform plan \
            -var-file=environments/staging.tfvars \
            -detailed-exitcode \
            -no-color \
            -lock=false \
            2>&1 | tee drift-staging.txt
          
          EXITCODE=${PIPESTATUS[0]}
          echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT
          exit 0

      - name: Check for Drift
        id: drift
        run: |
          EXITCODE="${{ steps.plan.outputs.exitcode }}"
          
          if [ "$EXITCODE" == "2" ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "### âš ï¸ Drift Detected in Staging Environment" >> $GITHUB_STEP_SUMMARY
          elif [ "$EXITCODE" == "1" ]; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "### âŒ Terraform Plan Failed in Staging Environment" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "### âœ… No Drift Detected in Staging Environment" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Drift Report
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-staging-${{ github.run_number }}
          path: drift-staging.txt
          retention-days: 30

      - name: Create Issue for Drift
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const drift = fs.readFileSync('drift-staging.txt', 'utf8');
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['drift-detection', 'staging'],
              state: 'open'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'âš ï¸ Configuration Drift Detected - Staging Environment',
                body: `## Configuration Drift Detected
            
            Drift was detected in the **Staging** environment during scheduled checks.
            
            **Detection Time:** ${new Date().toISOString()}
            **Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ### Drift Details
            
            \`\`\`terraform
            ${drift.substring(0, 5000)}
            \`\`\`
            
            ### Recommended Actions
            1. Review the drift details above
            2. Determine if the changes are intentional
            3. Update Terraform code or revert manual changes
            4. Run \`terraform apply\` to align infrastructure with code
            `,
                labels: ['drift-detection', 'staging', 'infrastructure']
              });
            }

  drift-detection-prod:
    name: Drift Detection - Production
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' || 
      inputs.environment == 'all' || 
      inputs.environment == 'prod'
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    outputs:
      drift_detected: ${{ steps.drift.outputs.drift_detected }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan (Drift Check)
        id: plan
        run: |
          set -o pipefail
          
          echo "Running drift detection plan for Production environment..."
          echo "This is a READ-ONLY operation - no changes will be applied."
          echo ""
          
          terraform plan \
            -var-file=environments/prod.tfvars \
            -detailed-exitcode \
            -no-color \
            -lock=false \
            2>&1 | tee drift-prod.txt
          
          EXITCODE=${PIPESTATUS[0]}
          echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT
          exit 0

      - name: Check for Drift
        id: drift
        run: |
          EXITCODE="${{ steps.plan.outputs.exitcode }}"
          
          if [ "$EXITCODE" == "2" ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo ""
            echo "ðŸš¨ CRITICAL: DRIFT DETECTED in Production environment"
            echo ""
            echo "### ðŸš¨ CRITICAL: Drift Detected in Production" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Immediate attention required!** Configuration drift was found in production." >> $GITHUB_STEP_SUMMARY
          elif [ "$EXITCODE" == "1" ]; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "### âŒ Terraform Plan Failed in Production" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo ""
            echo "âœ… No drift detected in Production environment"
            echo ""
            echo "### âœ… No Drift Detected in Production" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure matches Terraform configuration." >> $GITHUB_STEP_SUMMARY
          fi
          
          # Add plan output to summary
          if [ -f drift-prod.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Plan Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 drift-prod.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Drift Report
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-prod-${{ github.run_number }}
          path: drift-prod.txt
          retention-days: 90

      - name: Create Critical Issue for Production Drift
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const drift = fs.readFileSync('drift-prod.txt', 'utf8');
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['drift-detection', 'prod', 'critical'],
              state: 'open'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ CRITICAL: Configuration Drift Detected - Production',
                body: `## ðŸš¨ CRITICAL: Production Drift Detected
            
            **IMMEDIATE ATTENTION REQUIRED**
            
            Configuration drift has been detected in the **Production** environment.
            
            **Detection Time:** ${new Date().toISOString()}
            **Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ### Drift Details
            
            \`\`\`terraform
            ${drift.substring(0, 5000)}
            \`\`\`
            
            ### Required Actions
            1. ðŸ” **Investigate immediately** - Determine cause of drift
            2. ðŸ“ **Document findings** - Add comments to this issue
            3. âš ï¸ **Assess impact** - Determine if security/compliance affected
            4. ðŸ”§ **Remediate** - Update Terraform or revert manual changes
            5. âœ… **Verify** - Ensure infrastructure matches desired state
            
            ### Possible Causes
            - Manual changes in Azure Portal
            - Auto-scaling events
            - Azure policy enforcement
            - External automation tools
            
            ### Download Artifacts
            Full drift report available in Actions run artifacts (90-day retention).
            
            **Priority:** Critical
            `,
                labels: ['drift-detection', 'prod', 'critical', 'infrastructure']
              });
            } else {
              // Update existing issue with new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## âš ï¸ Drift Still Present
            
            **Detection Time:** ${new Date().toISOString()}
            **Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            Production drift is still present. Please investigate urgently.
            `
              });
            }

  summary:
    name: Drift Detection Summary
    runs-on: ubuntu-latest
    needs: [drift-detection-dev, drift-detection-staging, drift-detection-prod]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "### ðŸ“Š Drift Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Type:** ${{ github.event_name == 'schedule' && 'Scheduled (Daily)' || 'Manual' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status | Drift Detected |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|----------------|" >> $GITHUB_STEP_SUMMARY
          
          # Dev status
          DEV_RESULT="${{ needs.drift-detection-dev.result }}"
          DEV_DRIFT="${{ needs.drift-detection-dev.outputs.drift_detected }}"
          if [ "$DEV_RESULT" == "skipped" ]; then
            echo "| Dev | â­ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          elif [ "$DEV_RESULT" == "success" ] && [ "$DEV_DRIFT" == "true" ]; then
            echo "| Dev | âš ï¸ Drift Found | Yes |" >> $GITHUB_STEP_SUMMARY
          elif [ "$DEV_RESULT" == "success" ]; then
            echo "| Dev | âœ… Clean | No |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Dev | âŒ Failed | Unknown |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Staging status
          STAGING_RESULT="${{ needs.drift-detection-staging.result }}"
          STAGING_DRIFT="${{ needs.drift-detection-staging.outputs.drift_detected }}"
          if [ "$STAGING_RESULT" == "skipped" ]; then
            echo "| Staging | â­ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          elif [ "$STAGING_RESULT" == "success" ] && [ "$STAGING_DRIFT" == "true" ]; then
            echo "| Staging | âš ï¸ Drift Found | Yes |" >> $GITHUB_STEP_SUMMARY
          elif [ "$STAGING_RESULT" == "success" ]; then
            echo "| Staging | âœ… Clean | No |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Staging | âŒ Failed | Unknown |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Prod status
          PROD_RESULT="${{ needs.drift-detection-prod.result }}"
          PROD_DRIFT="${{ needs.drift-detection-prod.outputs.drift_detected }}"
          if [ "$PROD_RESULT" == "skipped" ]; then
            echo "| Production | â­ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          elif [ "$PROD_RESULT" == "success" ] && [ "$PROD_DRIFT" == "true" ]; then
            echo "| Production | ðŸš¨ CRITICAL | Yes |" >> $GITHUB_STEP_SUMMARY
          elif [ "$PROD_RESULT" == "success" ]; then
            echo "| Production | âœ… Clean | No |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Production | âŒ Failed | Unknown |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [ "$PROD_DRIFT" == "true" ]; then
            echo "### ðŸš¨ Action Required" >> $GITHUB_STEP_SUMMARY
            echo "Production drift detected! Check open issues immediately." >> $GITHUB_STEP_SUMMARY
          elif [ "$DEV_DRIFT" == "true" ] || [ "$STAGING_DRIFT" == "true" ]; then
            echo "### âš ï¸ Action Recommended" >> $GITHUB_STEP_SUMMARY
            echo "Non-production drift detected. Review and remediate when convenient." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… All Clear" >> $GITHUB_STEP_SUMMARY
            echo "All scanned environments are in sync with Terraform configuration." >> $GITHUB_STEP_SUMMARY
          fi