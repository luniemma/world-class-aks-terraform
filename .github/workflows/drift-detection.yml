name: Drift Detection

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check for drift'
        required: false
        type: choice
        options:
          - all
          - dev
          - staging
          - prod
        default: 'all'

permissions:
  contents: read
  issues: write
  id-token: write
  pull-requests: write
  repository-projects: write
  packages: write
  actions: write
  
env:
  TERRAFORM_VERSION: '1.6.0'
  LOCK_TIME: '300s'

jobs:
  drift-detection-dev:
    name: Drift Detection - Dev
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.environment == 'all' || inputs.environment == 'dev'
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    outputs:
      drift_detected: ${{ steps.drift.outputs.drift_detected }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Get Storage Access Key
        run: |
          ACCESS_KEY=$(az storage account keys list \
            --resource-group terraform-state-rg \
            --account-name tfstateaksproject \
            --query '[0].value' -o tsv)
          echo "::add-mask::$ACCESS_KEY"
          echo "ARM_ACCESS_KEY=$ACCESS_KEY" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init

      - name: Select Workspace
        run: |
          terraform workspace select dev || terraform workspace new dev
          echo "Using workspace: $(terraform workspace show)"

      - name: Terraform Plan (Drift Check)
        id: plan
        run: |
          terraform plan \
            -var-file=environments/dev.tfvars \
            -detailed-exitcode \
            -no-color \
            -lock=false > drift-dev.txt 2>&1 || EXITCODE=$?
          
          EXITCODE=${EXITCODE:-0}
          cat drift-dev.txt
          echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT

      - name: Check for Drift
        id: drift
        run: |
          EXITCODE="${{ steps.plan.outputs.exitcode }}"
          
          if [ "$EXITCODE" == "2" ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "### âš ï¸ Drift Detected - Dev" >> $GITHUB_STEP_SUMMARY
          elif [ "$EXITCODE" == "1" ]; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "### âŒ Plan Failed - Dev" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "### âœ… No Drift - Dev" >> $GITHUB_STEP_SUMMARY
          fi

  drift-detection-staging:
    name: Drift Detection - Staging
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.environment == 'all' || inputs.environment == 'staging'
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    outputs:
      drift_detected: ${{ steps.drift.outputs.drift_detected }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Get Storage Access Key
        run: |
          ACCESS_KEY=$(az storage account keys list \
            --resource-group terraform-state-rg \
            --account-name tfstateaksproject \
            --query '[0].value' -o tsv)
          echo "::add-mask::$ACCESS_KEY"
          echo "ARM_ACCESS_KEY=$ACCESS_KEY" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init

      - name: Select Workspace
        run: |
          terraform workspace select staging || terraform workspace new staging
          echo "Using workspace: $(terraform workspace show)"

      - name: Terraform Plan (Drift Check)
        id: plan
        run: |
          terraform plan \
            -var-file=environments/staging.tfvars \
            -detailed-exitcode \
            -no-color \
            -lock=false > drift-staging.txt 2>&1 || EXITCODE=$?
          
          EXITCODE=${EXITCODE:-0}
          cat drift-staging.txt
          echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT

      - name: Check for Drift
        id: drift
        run: |
          EXITCODE="${{ steps.plan.outputs.exitcode }}"
          
          if [ "$EXITCODE" == "2" ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "### âš ï¸ Drift Detected - Staging" >> $GITHUB_STEP_SUMMARY
          elif [ "$EXITCODE" == "1" ]; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "### âŒ Plan Failed - Staging" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "### âœ… No Drift - Staging" >> $GITHUB_STEP_SUMMARY
          fi

  drift-detection-prod:
    name: Drift Detection - Production
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.environment == 'all' || inputs.environment == 'prod'
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    outputs:
      drift_detected: ${{ steps.drift.outputs.drift_detected }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Get Storage Access Key
        run: |
          ACCESS_KEY=$(az storage account keys list \
            --resource-group terraform-state-rg \
            --account-name tfstateaksproject \
            --query '[0].value' -o tsv)
          echo "::add-mask::$ACCESS_KEY"
          echo "ARM_ACCESS_KEY=$ACCESS_KEY" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init

      - name: Select Workspace
        run: |
          terraform workspace select prod || terraform workspace new prod
          echo "Using workspace: $(terraform workspace show)"

      - name: Terraform Plan (Drift Check)
        id: plan
        run: |
          terraform plan \
            -var-file=environments/prod.tfvars \
            -detailed-exitcode \
            -no-color \
            -lock=false > drift-prod.txt 2>&1 || EXITCODE=$?
          
          EXITCODE=${EXITCODE:-0}
          cat drift-prod.txt
          echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT

      - name: Check for Drift
        id: drift
        run: |
          EXITCODE="${{ steps.plan.outputs.exitcode }}"
          
          if [ "$EXITCODE" == "2" ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "### ðŸš¨ CRITICAL: Drift Detected - Production" >> $GITHUB_STEP_SUMMARY
          elif [ "$EXITCODE" == "1" ]; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "### âŒ Plan Failed - Production" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "### âœ… No Drift - Production" >> $GITHUB_STEP_SUMMARY
          fi

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [drift-detection-dev, drift-detection-staging, drift-detection-prod]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "### ðŸ“Š Drift Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Dev
          if [ "${{ needs.drift-detection-dev.outputs.drift_detected }}" == "true" ]; then
            echo "| Dev | âš ï¸ Drift |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.drift-detection-dev.result }}" == "success" ]; then
            echo "| Dev | âœ… Clean |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.drift-detection-dev.result }}" == "skipped" ]; then
            echo "| Dev | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Dev | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Staging
          if [ "${{ needs.drift-detection-staging.outputs.drift_detected }}" == "true" ]; then
            echo "| Staging | âš ï¸ Drift |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.drift-detection-staging.result }}" == "success" ]; then
            echo "| Staging | âœ… Clean |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.drift-detection-staging.result }}" == "skipped" ]; then
            echo "| Staging | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Staging | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Prod
          if [ "${{ needs.drift-detection-prod.outputs.drift_detected }}" == "true" ]; then
            echo "| Production | ðŸš¨ CRITICAL |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.drift-detection-prod.result }}" == "success" ]; then
            echo "| Production | âœ… Clean |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.drift-detection-prod.result }}" == "skipped" ]; then
            echo "| Production | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Production | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi