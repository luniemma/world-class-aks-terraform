name: Drift Detection

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check for drift'
        required: false
        type: choice
        options:
          - all
          - dev
          - staging
          - prod
        default: 'all'

permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: write

jobs:
  drift-detection-dev:
    name: Drift Detection - Dev
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' || 
      inputs.environment == 'all' || 
      inputs.environment == 'dev'
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var-file=environments/dev.tfvars \
            -detailed-exitcode \
            -no-color | tee drift-dev.txt
        continue-on-error: true

      - name: Check for Drift
        id: drift
        run: |
          EXITCODE=${{ steps.plan.outcome }}
          
          if [ "$EXITCODE" == "failure" ]; then
            # Exit code 2 means changes detected (drift)
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "### âš ï¸ Drift Detected in Dev Environment" >> $GITHUB_STEP_SUMMARY
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "### âœ… No Drift Detected in Dev Environment" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Drift Report
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-dev
          path: drift-dev.txt
          retention-days: 30

      - name: Create Issue for Drift
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const drift = fs.readFileSync('drift-dev.txt', 'utf8');
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['drift-detection', 'dev'],
              state: 'open'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'âš ï¸ Configuration Drift Detected - Dev Environment',
                body: `## Configuration Drift Detected
                
                Drift was detected in the **Dev** environment during scheduled checks.
                
                **Detection Time:** ${new Date().toISOString()}
                **Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
                
                ### Drift Details
                
                \`\`\`terraform
                ${drift.substring(0, 5000)}
                \`\`\`
                
                ### Recommended Actions
                1. Review the drift details above
                2. Determine if the changes are intentional
                3. Update Terraform code or revert manual changes
                4. Run \`terraform apply\` to align infrastructure with code
                
                ### Related Artifacts
                Download the full drift report from the Actions run artifacts.
                `,
                labels: ['drift-detection', 'dev', 'infrastructure']
              });
            }

  drift-detection-prod:
    name: Drift Detection - Production
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' || 
      inputs.environment == 'all' || 
      inputs.environment == 'prod'
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var-file=environments/prod.tfvars \
            -detailed-exitcode \
            -no-color | tee drift-prod.txt
        continue-on-error: true

      - name: Check for Drift
        id: drift
        run: |
          EXITCODE=${{ steps.plan.outcome }}
          
          if [ "$EXITCODE" == "failure" ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "### ðŸš¨ CRITICAL: Drift Detected in Production" >> $GITHUB_STEP_SUMMARY
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "### âœ… No Drift Detected in Production" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Drift Report
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-prod
          path: drift-prod.txt
          retention-days: 90

      - name: Create Critical Issue for Production Drift
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const drift = fs.readFileSync('drift-prod.txt', 'utf8');
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['drift-detection', 'prod', 'critical'],
              state: 'open'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ CRITICAL: Configuration Drift Detected - Production',
                body: `## ðŸš¨ CRITICAL: Production Drift Detected
                
                **IMMEDIATE ATTENTION REQUIRED**
                
                Configuration drift has been detected in the **Production** environment.
                
                **Detection Time:** ${new Date().toISOString()}
                **Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
                
                ### Drift Details
                
                \`\`\`terraform
                ${drift.substring(0, 5000)}
                \`\`\`
                
                ### Required Actions
                1. ðŸ” **Investigate immediately** - Determine cause of drift
                2. ðŸ“ **Document findings** - Add comments to this issue
                3. âš ï¸ **Assess impact** - Determine if security/compliance affected
                4. ðŸ”§ **Remediate** - Update Terraform or revert manual changes
                5. âœ… **Verify** - Ensure infrastructure matches desired state
                
                ### Possible Causes
                - Manual changes in Azure Portal
                - Auto-scaling events
                - Azure policy enforcement
                - External automation tools
                
                ### Download Artifacts
                Full drift report available in Actions run artifacts (90-day retention).
                
                **Priority:** Critical
                **Assignees:** @platform-team
                `,
                labels: ['drift-detection', 'prod', 'critical', 'infrastructure'],
                assignees: [] // Add your team members here
              });
            }

  summary:
    name: Drift Detection Summary
    runs-on: ubuntu-latest
    needs: [drift-detection-dev, drift-detection-prod]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "### Drift Detection Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- Dev: ${{ needs.drift-detection-dev.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Production: ${{ needs.drift-detection-prod.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.drift-detection-prod.result }}" == "failure" ]; then
            echo "âš ï¸ **Action Required:** Check open issues for drift details" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All environments are in sync with Terraform code" >> $GITHUB_STEP_SUMMARY
          fi
