name: Reusable Terraform Workflow

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy (dev, staging, prod)'
        required: true
        type: string
      terraform_version:
        description: 'Terraform version to use'
        required: false
        type: string
        default: '1.6.0'
      working_directory:
        description: 'Working directory for Terraform'
        required: false
        type: string
        default: '.'
      var_file:
        description: 'Variable file to use (e.g., environments/prod.tfvars)'
        required: false
        type: string
        default: ''
      terraform_action:
        description: 'Terraform action to perform (plan, apply, destroy)'
        required: true
        type: string
      auto_approve:
        description: 'Auto approve Terraform apply/destroy'
        required: false
        type: boolean
        default: false
      enable_checkov:
        description: 'Enable Checkov security scanning'
        required: false
        type: boolean
        default: true
      enable_tfsec:
        description: 'Enable tfsec security scanning'
        required: false
        type: boolean
        default: true
      enable_infracost:
        description: 'Enable Infracost estimation'
        required: false
        type: boolean
        default: true
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_CLIENT_SECRET:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      INFRACOST_API_KEY:
        required: false
    outputs:
      cluster_name:
        description: 'AKS cluster name'
        value: ${{ jobs.terraform-apply.outputs.cluster_name }}
      resource_group:
        description: 'Resource group name'
        value: ${{ jobs.terraform-apply.outputs.resource_group }}
      plan_exitcode:
        description: 'Terraform plan exit code (0=no changes, 2=changes)'
        value: ${{ jobs.terraform-plan.outputs.exitcode }}

env:
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

jobs:
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init -backend=false

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Format Check Results
        if: steps.fmt.outcome == 'failure'
        run: |
          echo "::warning::Terraform files are not properly formatted"
          echo "Run 'terraform fmt -recursive' to fix formatting"

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: terraform-validate
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run tfsec
        if: inputs.enable_tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ${{ inputs.working_directory }}
          soft_fail: true
          format: sarif
          sarif_file: tfsec-results.sarif

      - name: Upload tfsec Results to Security Tab
        if: inputs.enable_tfsec && always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ inputs.working_directory }}/tfsec-results.sarif
          category: tfsec
        continue-on-error: true

      - name: Run Checkov
        if: inputs.enable_checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ${{ inputs.working_directory }}
          framework: terraform
          soft_fail: true
          output_format: sarif
          output_file_path: checkov-results.sarif

      - name: Upload Checkov Results to Security Tab
        if: inputs.enable_checkov && always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-results.sarif
          category: checkov
        continue-on-error: true

      - name: Security Scan Summary
        if: always()
        run: |
          echo "### Security Scan Results ðŸ”’" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- tfsec: ${{ inputs.enable_tfsec && 'Completed' || 'Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Checkov: ${{ inputs.enable_checkov && 'Completed' || 'Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the Security tab for detailed results" >> $GITHUB_STEP_SUMMARY

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: security-scan
    environment: ${{ inputs.environment }}
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    outputs:
      exitcode: ${{ steps.plan.outputs.exitcode }}
      plan_id: ${{ steps.plan.outputs.plan_id }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Terraform Init
        id: init
        run: |
          echo "Initializing Terraform..."
          terraform init

      - name: Terraform Plan
        id: plan
        run: |
          PLAN_FILE="tfplan-${{ inputs.environment }}-${{ github.run_number }}"
          
          if [ -n "${{ inputs.var_file }}" ]; then
            echo "Using variable file: ${{ inputs.var_file }}"
            terraform plan \
              -var-file="${{ inputs.var_file }}" \
              -out="${PLAN_FILE}" \
              -detailed-exitcode \
              -no-color | tee plan.txt
          else
            terraform plan \
              -out="${PLAN_FILE}" \
              -detailed-exitcode \
              -no-color | tee plan.txt
          fi
          
          EXITCODE=${PIPESTATUS[0]}
          echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT
          echo "plan_id=$PLAN_FILE" >> $GITHUB_OUTPUT
          
          # Exit code 0 = no changes, 1 = error, 2 = changes present
          if [ $EXITCODE -eq 1 ]; then
            exit 1
          fi

      - name: Generate Plan Summary
        if: always()
        run: |
          echo "### Terraform Plan Summary ðŸ“‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Terraform Version:** ${{ inputs.terraform_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Plan Exit Code:** ${{ steps.plan.outputs.exitcode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f plan.txt ]; then
            echo "<details><summary>Plan Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 plan.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ inputs.environment }}-${{ github.run_number }}
          path: ${{ inputs.working_directory }}/tfplan-*
          retention-days: 5

      - name: Upload Plan Output
        uses: actions/upload-artifact@v4
        with:
          name: plan-output-${{ inputs.environment }}-${{ github.run_number }}
          path: ${{ inputs.working_directory }}/plan.txt
          retention-days: 5

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('${{ inputs.working_directory }}/plan.txt', 'utf8');
            const truncatedPlan = plan.length > 65000 ? plan.substring(0, 65000) + '\n\n... (truncated)' : plan;
            
            const output = `#### Terraform Plan - ${{ inputs.environment }} ðŸ“–
            
            **Terraform Version:** ${{ inputs.terraform_version }}
            **Plan Exit Code:** ${{ steps.plan.outputs.exitcode }}
            
            <details><summary>Show Plan</summary>
            
            \`\`\`terraform
            ${truncatedPlan}
            \`\`\`
            
            </details>
            
            **Action:** ${{ inputs.terraform_action }}
            **Pushed by:** @${{ github.actor }}
            **Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  cost-estimate:
    name: Cost Estimation
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: |
      inputs.enable_infracost &&
      needs.terraform-plan.result == 'success'
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Setup Infracost
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ inputs.environment }}-${{ github.run_number }}
          path: ${{ inputs.working_directory }}

      - name: Generate Infracost JSON
        run: |
          infracost breakdown \
            --path tfplan-${{ inputs.environment }}-${{ github.run_number }} \
            --format json \
            --out-file /tmp/infracost.json

      - name: Post Infracost Comment
        if: github.event_name == 'pull_request'
        uses: infracost/actions/comment@v1
        with:
          path: /tmp/infracost.json
          behavior: update

      - name: Generate Cost Summary
        run: |
          echo "### Cost Estimation ðŸ’°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          infracost breakdown \
            --path tfplan-${{ inputs.environment }}-${{ github.run_number }} \
            --format table >> $GITHUB_STEP_SUMMARY

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: |
      inputs.terraform_action == 'apply' &&
      needs.terraform-plan.outputs.exitcode == '2'
    environment: 
      name: ${{ inputs.environment }}
      url: https://portal.azure.com
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    outputs:
      cluster_name: ${{ steps.outputs.outputs.cluster_name }}
      resource_group: ${{ steps.outputs.outputs.resource_group }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Terraform Init
        run: terraform init

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ inputs.environment }}-${{ github.run_number }}
          path: ${{ inputs.working_directory }}

      - name: Terraform Apply
        id: apply
        run: |
          echo "Applying Terraform plan..."
          terraform apply \
            -auto-approve \
            tfplan-${{ inputs.environment }}-${{ github.run_number }}

      - name: Get Terraform Outputs
        id: outputs
        run: |
          CLUSTER_NAME=$(terraform output -raw aks_cluster_name 2>/dev/null || echo "")
          RESOURCE_GROUP=$(terraform output -raw resource_group_name 2>/dev/null || echo "")
          
          echo "cluster_name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "resource_group=$RESOURCE_GROUP" >> $GITHUB_OUTPUT

      - name: Generate Apply Summary
        run: |
          echo "### Terraform Apply Completed âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster Name:** ${{ steps.outputs.outputs.cluster_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ steps.outputs.outputs.resource_group }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View in [Azure Portal](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ steps.outputs.outputs.resource_group }}/overview)" >> $GITHUB_STEP_SUMMARY

      - name: Save Outputs
        run: |
          terraform output -json > terraform-outputs.json

      - name: Upload Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ inputs.environment }}-${{ github.run_number }}
          path: ${{ inputs.working_directory }}/terraform-outputs.json
          retention-days: 30

  terraform-destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: inputs.terraform_action == 'destroy'
    environment: 
      name: ${{ inputs.environment }}-destroy
      url: https://portal.azure.com
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Terraform Init
        run: terraform init

      - name: Terraform Destroy
        run: |
          if [ -n "${{ inputs.var_file }}" ]; then
            terraform destroy \
              -var-file="${{ inputs.var_file }}" \
              -auto-approve
          else
            terraform destroy -auto-approve
          fi

      - name: Generate Destroy Summary
        run: |
          echo "### Terraform Destroy Completed ðŸ—‘ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Destroyed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
