name: Reusable Terraform Workflow

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy (dev, staging, prod)'
        required: true
        type: string
      terraform_version:
        description: 'Terraform version to use'
        required: false
        type: string
        default: '1.6.0'
      working_directory:
        description: 'Working directory for Terraform'
        required: false
        type: string
        default: '.'
      var_file:
        description: 'Variable file to use (e.g., environments/prod.tfvars)'
        required: false
        type: string
        default: ''
      terraform_action:
        description: 'Terraform action to perform (plan, apply, destroy)'
        required: true
        type: string
      auto_approve:
        description: 'Auto approve Terraform apply/destroy'
        required: false
        type: boolean
        default: false
      enable_checkov:
        description: 'Enable Checkov security scanning'
        required: false
        type: boolean
        default: true
      enable_tfsec:
        description: 'Enable tfsec security scanning'
        required: false
        type: boolean
        default: true
      enable_infracost:
        description: 'Enable Infracost estimation'
        required: false
        type: boolean
        default: true
      enable_post_deploy_tests:
        description: 'Enable post-deployment tests'
        required: false
        type: boolean
        default: true
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_CLIENT_SECRET:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      INFRACOST_API_KEY:
        required: false
      ARM_ACCESS_KEY:
        required: false
    outputs:
      cluster_name:
        description: 'AKS cluster name'
        value: ${{ jobs.terraform-apply.outputs.cluster_name }}
      resource_group:
        description: 'Resource group name'
        value: ${{ jobs.terraform-apply.outputs.resource_group }}
      plan_exitcode:
        description: 'Terraform plan exit code (0=no changes, 2=changes)'
        value: ${{ jobs.terraform-plan.outputs.exitcode }}

env:
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_ACCESS_KEY: ${{ secrets.ARM_ACCESS_KEY }}

jobs:
  # ===========================================================================
  # TERRAFORM VALIDATE
  # ===========================================================================
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Terraform Format Check
        id: fmt-check
        run: |
          if terraform fmt -check -recursive; then
            echo "formatted=true" >> $GITHUB_OUTPUT
          else
            echo "formatted=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Terraform Format (Auto-fix)
        id: fmt
        if: steps.fmt-check.outputs.formatted == 'false'
        run: |
          echo "Auto-formatting Terraform files..."
          terraform fmt -recursive
          echo "âœ… Formatting complete"

      - name: Terraform Init
        id: init
        run: terraform init -backend=false

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Validation Summary
        if: always()
        run: |
          echo "### Terraform Validation ðŸ“‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.fmt-check.outputs.formatted }}" == "true" ]; then
            echo "| Format | âœ… Already formatted |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Format | ðŸ”§ Auto-formatted |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.init.outcome }}" == "success" ]; then
            echo "| Init | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Init | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.validate.outcome }}" == "success" ]; then
            echo "| Validate | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Validate | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # SECURITY SCANNING
  # ===========================================================================
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: terraform-validate
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run tfsec
        if: inputs.enable_tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ${{ inputs.working_directory }}
          soft_fail: true
        continue-on-error: true

      - name: Run Checkov
        if: inputs.enable_checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ${{ inputs.working_directory }}
          framework: terraform
          soft_fail: true
          skip_check: CKV_AZURE_117,CKV_AZURE_226,CKV_AZURE_227,CKV_AZURE_232
        continue-on-error: true

      - name: Security Scan Summary
        if: always()
        run: |
          echo "### Security Scan Results ðŸ”’" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- tfsec: ${{ inputs.enable_tfsec && 'Completed' || 'Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Checkov: ${{ inputs.enable_checkov && 'Completed' || 'Skipped' }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # TERRAFORM PLAN
  # ===========================================================================
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: security-scan
    environment: ${{ inputs.environment }}
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    outputs:
      exitcode: ${{ steps.plan.outputs.exitcode }}
      plan_id: ${{ steps.plan.outputs.plan_id }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Terraform Init
        id: init
        run: |
          echo "Initializing Terraform..."
          terraform init

      - name: Select Workspace
        run: |
          terraform workspace select ${{ inputs.environment }} || terraform workspace new ${{ inputs.environment }}
          echo "Using workspace: $(terraform workspace show)"

      - name: Terraform Plan
        id: plan
        run: |
          PLAN_FILE="tfplan-${{ inputs.environment }}-${{ github.run_id }}"
          
          if [ -n "${{ inputs.var_file }}" ]; then
            echo "Using variable file: ${{ inputs.var_file }}"
            terraform plan \
              -var-file="${{ inputs.var_file }}" \
              -out="${PLAN_FILE}" \
              -detailed-exitcode \
              -no-color > plan.txt 2>&1 || EXITCODE=$?
          else
            terraform plan \
              -out="${PLAN_FILE}" \
              -detailed-exitcode \
              -no-color > plan.txt 2>&1 || EXITCODE=$?
          fi
          
          EXITCODE=${EXITCODE:-0}
          cat plan.txt
          
          echo ""
          echo "========================================="
          echo "Terraform plan exit code: $EXITCODE"
          echo "  0 = No changes"
          echo "  1 = Error"
          echo "  2 = Changes detected"
          echo "========================================="
          
          echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT
          echo "plan_id=$PLAN_FILE" >> $GITHUB_OUTPUT
          
          if [ "$EXITCODE" -eq 1 ]; then
            echo "::error::Terraform plan failed with errors"
            exit 1
          fi
          exit 0

      - name: Generate Plan Summary
        if: always()
        run: |
          echo "### Terraform Plan Summary ðŸ“‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Plan Exit Code:** ${{ steps.plan.outputs.exitcode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.plan.outputs.exitcode }}" == "0" ]; then
            echo "â„¹ï¸ **No changes detected**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.plan.outputs.exitcode }}" == "2" ]; then
            echo "âœ… **Changes detected**" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f plan.txt ]; then
            echo "<details><summary>Plan Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 plan.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Plan Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ inputs.environment }}-${{ inputs.terraform_action }}-${{ github.run_id }}
          path: ${{ inputs.working_directory }}/tfplan-*
          retention-days: 5

      - name: Upload Plan Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: plan-output-${{ inputs.environment }}-${{ inputs.terraform_action }}-${{ github.run_id }}
          path: ${{ inputs.working_directory }}/plan.txt
          retention-days: 5

  # ===========================================================================
  # TERRAFORM APPLY
  # ===========================================================================
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: |
      always() &&
      inputs.terraform_action == 'apply' &&
      needs.terraform-plan.outputs.exitcode == '2' &&
      needs.terraform-plan.result == 'success'
    environment: 
      name: ${{ inputs.environment }}
      url: https://portal.azure.com
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    outputs:
      cluster_name: ${{ steps.outputs.outputs.cluster_name }}
      resource_group: ${{ steps.outputs.outputs.resource_group }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Terraform Init
        run: terraform init

      - name: Select Workspace
        run: |
          terraform workspace select ${{ inputs.environment }} || terraform workspace new ${{ inputs.environment }}
          echo "Using workspace: $(terraform workspace show)"

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ inputs.environment }}-${{ inputs.terraform_action }}-${{ github.run_id }}
          path: ${{ inputs.working_directory }}

      - name: Terraform Apply
        id: apply
        run: |
          echo "Applying Terraform plan..."
          PLAN_FILE=$(ls tfplan-* 2>/dev/null | head -1)
          if [ -z "$PLAN_FILE" ]; then
            echo "::error::Plan file not found"
            exit 1
          fi
          terraform apply -auto-approve "$PLAN_FILE"

      - name: Get Terraform Outputs
        id: outputs
        run: |
          CLUSTER_NAME=$(terraform output -raw aks_cluster_name 2>/dev/null || echo "")
          RESOURCE_GROUP=$(terraform output -raw resource_group_name 2>/dev/null || echo "")
          
          echo "cluster_name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "resource_group=$RESOURCE_GROUP" >> $GITHUB_OUTPUT

      - name: Generate Apply Summary
        run: |
          echo "### Terraform Apply Completed âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster Name:** ${{ steps.outputs.outputs.cluster_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ steps.outputs.outputs.resource_group }}" >> $GITHUB_STEP_SUMMARY

      - name: Upload Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ inputs.environment }}-${{ github.run_id }}
          path: ${{ inputs.working_directory }}/terraform-outputs.json
          retention-days: 30
        continue-on-error: true

  # ===========================================================================
  # POST-DEPLOYMENT TESTS
  # ===========================================================================
  post-deploy-tests:
    name: Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: terraform-apply
    if: |
      always() &&
      inputs.terraform_action == 'apply' &&
      needs.terraform-apply.result == 'success' &&
      inputs.enable_post_deploy_tests
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Install kubectl and kubelogin
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          
          curl -LO "https://github.com/Azure/kubelogin/releases/download/v0.1.4/kubelogin-linux-amd64.zip"
          unzip -o kubelogin-linux-amd64.zip -d kubelogin-extract
          sudo mv kubelogin-extract/bin/linux_amd64/kubelogin /usr/local/bin/
          rm -rf kubelogin-extract kubelogin-linux-amd64.zip

      - name: Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ needs.terraform-apply.outputs.resource_group }} \
            --name ${{ needs.terraform-apply.outputs.cluster_name }} \
            --overwrite-existing
          kubelogin convert-kubeconfig -l azurecli

      - name: Verify Cluster
        run: |
          echo "### Post-Deployment Verification ðŸ”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if kubectl cluster-info &>/dev/null; then
            echo "âœ… Cluster is accessible" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl get nodes >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Unable to get nodes" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Unable to access cluster (RBAC permissions may be needed)" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

  # ===========================================================================
  # TERRAFORM DESTROY
  # ===========================================================================
  terraform-destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: inputs.terraform_action == 'destroy'
    environment: 
      name: ${{ inputs.environment }}-destroy
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Terraform Init
        run: terraform init

      - name: Select Workspace
        run: |
          terraform workspace select ${{ inputs.environment }} || terraform workspace new ${{ inputs.environment }}
          echo "Using workspace: $(terraform workspace show)"

      - name: Terraform Destroy
        run: |
          if [ -n "${{ inputs.var_file }}" ]; then
            terraform destroy -var-file="${{ inputs.var_file }}" -auto-approve
          else
            terraform destroy -auto-approve
          fi

      - name: Generate Destroy Summary
        run: |
          echo "### Terraform Destroy Completed ðŸ—‘ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Destroyed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY