name: Manual Terraform Operations

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'
      terraform_action:
        description: 'Terraform action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: 'plan'
      confirm_destroy:
        description: 'Type "DESTROY" to confirm destruction (required for destroy action)'
        required: false
        type: string
        default: ''
      confirm_prod:
        description: 'Type "PRODUCTION" to confirm production changes (required for prod apply/destroy)'
        required: false
        type: string
        default: ''
      skip_security_scan:
        description: 'Skip security scanning (not recommended)'
        required: false
        type: boolean
        default: false
      skip_post_deploy_tests:
        description: 'Skip post-deployment tests'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write
  security-events: write
  id-token: write
  issues: write

jobs:
  # ===========================================================================
  # SAFETY CHECKS
  # ===========================================================================
  safety-checks:
    name: Safety Checks
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.check.outputs.proceed }}
    steps:
      - name: Validate Inputs
        id: check
        run: |
          echo "### ðŸ” Safety Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          PROCEED="true"
          
          # Check destroy confirmation
          if [ "${{ inputs.terraform_action }}" == "destroy" ]; then
            if [ "${{ inputs.confirm_destroy }}" != "DESTROY" ]; then
              echo "| Destroy Confirmation | âŒ Failed - must type 'DESTROY' |" >> $GITHUB_STEP_SUMMARY
              echo "::error::Destroy action requires typing 'DESTROY' in the confirm_destroy field"
              PROCEED="false"
            else
              echo "| Destroy Confirmation | âœ… Confirmed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Destroy Confirmation | â­ï¸ Not required |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check production confirmation
          if [ "${{ inputs.environment }}" == "prod" ]; then
            if [ "${{ inputs.terraform_action }}" == "apply" ] || [ "${{ inputs.terraform_action }}" == "destroy" ]; then
              if [ "${{ inputs.confirm_prod }}" != "PRODUCTION" ]; then
                echo "| Production Confirmation | âŒ Failed - must type 'PRODUCTION' |" >> $GITHUB_STEP_SUMMARY
                echo "::error::Production changes require typing 'PRODUCTION' in the confirm_prod field"
                PROCEED="false"
              else
                echo "| Production Confirmation | âœ… Confirmed |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| Production Confirmation | â­ï¸ Not required for plan |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Production Confirmation | â­ï¸ Not required |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check business hours for production (optional warning)
          HOUR=$(date -u +%H)
          if [ "${{ inputs.environment }}" == "prod" ] && [ "${{ inputs.terraform_action }}" != "plan" ]; then
            if [ "$HOUR" -ge 14 ] && [ "$HOUR" -le 22 ]; then
              echo "| Business Hours Check | âš ï¸ Warning - deploying during peak hours (UTC) |" >> $GITHUB_STEP_SUMMARY
              echo "::warning::Deploying to production during potential peak hours (14:00-22:00 UTC)"
            else
              echo "| Business Hours Check | âœ… Off-peak hours |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Business Hours Check | â­ï¸ Not checked |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$PROCEED" == "true" ]; then
            echo "### âœ… All safety checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Safety checks failed - workflow will not proceed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "proceed=$PROCEED" >> $GITHUB_OUTPUT

      - name: Fail if Checks Failed
        if: steps.check.outputs.proceed != 'true'
        run: |
          echo "Safety checks failed. Please review the requirements and try again."
          exit 1

  # ===========================================================================
  # AUDIT LOG
  # ===========================================================================
  audit-log:
    name: Audit Log
    runs-on: ubuntu-latest
    needs: safety-checks
    if: needs.safety-checks.outputs.proceed == 'true'
    steps:
      - name: Log Operation
        run: |
          echo "### ðŸ“ Operation Audit Log" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| Operator | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Action | ${{ inputs.terraform_action }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Run ID | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Run Number | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | ${{ github.repository }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ref | ${{ github.ref }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SHA | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # TERRAFORM OPERATIONS
  # ===========================================================================
  terraform:
    name: Terraform ${{ inputs.terraform_action }} - ${{ inputs.environment }}
    needs: [safety-checks, audit-log]
    if: needs.safety-checks.outputs.proceed == 'true'
    uses: ./.github/workflows/terraform-reusable.yml
    with:
      environment: ${{ inputs.environment }}
      terraform_version: '1.6.0'
      var_file: 'environments/${{ inputs.environment }}.tfvars'
      terraform_action: ${{ inputs.terraform_action }}
      auto_approve: true
      enable_checkov: ${{ !inputs.skip_security_scan }}
      enable_tfsec: ${{ !inputs.skip_security_scan }}
      enable_infracost: true
      enable_post_deploy_tests: ${{ !inputs.skip_post_deploy_tests && inputs.terraform_action == 'apply' }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}

  # ===========================================================================
  # NOTIFICATION
  # ===========================================================================
  notify-completion:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: [safety-checks, terraform]
    if: always() && needs.safety-checks.outputs.proceed == 'true'
    steps:
      - name: Generate Completion Summary
        run: |
          echo "### ðŸ Operation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Action | ${{ inputs.terraform_action }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Result | ${{ needs.terraform.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Completed At | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| Operator | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.terraform_action }}" == "apply" ] && [ "${{ needs.terraform.result }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Deployed Resources" >> $GITHUB_STEP_SUMMARY
            echo "- **Cluster:** ${{ needs.terraform.outputs.cluster_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Resource Group:** ${{ needs.terraform.outputs.resource_group }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create Issue for Failed Production Operation
        if: |
          failure() &&
          inputs.environment == 'prod' &&
          inputs.terraform_action != 'plan'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Failed Production ${process.env.ACTION} - ${new Date().toISOString().split('T')[0]}`,
              body: `## Production Operation Failed
              
              **Operator:** @${{ github.actor }}
              **Action:** ${{ inputs.terraform_action }}
              **Environment:** ${{ inputs.environment }}
              **Timestamp:** ${new Date().toISOString()}
              **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              ### Required Actions
              1. Review the workflow logs for error details
              2. Assess the impact on production systems
              3. Determine if manual intervention is required
              4. Document findings in this issue
              
              ### Workflow Link
              ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              `,
              labels: ['incident', 'production', 'terraform']
            });
        env:
          ACTION: ${{ inputs.terraform_action }}